<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원가입</title>
    <link href="/css/join.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>

        .error-input {
            border-color: red;
        }
        .error-message{
            color: red;
            font-size: 12px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <a class="logoBtn" href="/"><img class="logo" src="/img/linkxLogo.png"></a>
    </div>

    <main>
    <div class="join-box">
        <h1>회원가입</h1>
        <form>
            <div class="form-group flex">
                <label for="loginId">아이디</label>
                <div class="row">
                    <input type="text" class="input-field" id="loginId" name="loginId" placeholder="아이디를 입력해 주세요." required>
                    <button type="button" class="duple-btn" onclick="$.checkLoginId();">중복체크</button>
                </div>
                <div id="loginId-error" class="error-message"></div> <!-- 오류 메시지 공간 -->
            </div>
            <div class="form-group">
                <label for="password">비밀번호</label>
                <input type="password" class="input-field" id="password" name="password" placeholder="비밀번호를 입력해 주세요." required>
                <div id="password-error" class="error-message"></div>
            </div>
            <div class="form-group">
                <label for="passwordCheck">비밀번호 재입력</label>
                <input type="password" class="input-field" id="passwordCheck" name="passwordCheck" placeholder="비밀번호를 다시 입력해 주세요." required>
                <div id="passwordCheck-error" class="error-message"></div>
            </div>
            <div class="form-group">
                <label for="name">이름</label>
                <input type="text" class="input-field" id="name" name="name" placeholder="이름을 입력해 주세요." required>
                <div id="name-error" class="error-message"></div>
            </div>
            <div class="form-group flex">
                <label for="nickname">닉네임</label>
                <div class="row">
                    <input type="text" class="input-field" id="nickname" name="nickname" placeholder="닉네임을 입력해 주세요." required>
                    <button type="button" class="duple-btn" onclick="$.checkNickname();">중복체크</button>
                </div>
                <div id="nickname-error" class="error-message"></div>
            </div>
            <div class="form-group">
                <label for="phone" >전화번호</label>
                <input type="tel" class="input-field" id="phone" name="phone" placeholder="전화번호를 입력해 주세요.( [ - ] 제외 11자리 )" required>
                <div id="phone-error" class="error-message"></div>
            </div>
            <div class="form-group flex">
                <label for="email">이메일</label>
                <div class="row">
                    <input type="email" class="input-field" id="email" name="email" placeholder="이메일을 입력해 주세요." required>
                    <button type="button" class="duple-btn" onclick="$.checkEmail();">중복체크</button>
                </div>
                <div id="email-error" class="error-message"></div>
            </div>
            <div class="form-group">
                <label for="univ">학교명</label>
                <input type="text" class="input-field" id="univ" name="univ" placeholder="학교명을 입력해 주세요." value="명지전문대학" readonly style="background-color: lightgrey">
                <div id="univ-error" class="error-message"></div>
            </div>
            <div class="form-group">
                <label for="majorId">학과</label>
                <select id="majorId" name="majorId">
                    <option value="" disabled selected>학과를 선택해 주세요</option>
                    <option value="1" id="cse">컴퓨터공학과</option>
                    <option value="2" id="cybersec">컴퓨터보안공학과</option>
                    <option value="3" id="elec">전자공학과</option>
                    <option value="4" id="ict">정보통신공학과</option>
                    <option value="5" id="mech">기계공학과</option>
                    <option value="6" id="ie">산업경영공학과</option>
                    <option value="7" id="ee">전기공학과</option>
                    <option value="8" id="civil">토목공학과</option>
                    <option value="9" id="geo">지적공간정보학과</option>
                    <option value="10" id="drone">드론정보공학과</option>
                    <option value="11" id="biz">경영학과</option>
                    <option value="12" id="tax">세무회계과</option>
                    <option value="13" id="welfare">사회복지과</option>
                    <option value="14" id="realEstate">부동산경영과</option>
                    <option value="15" id="aviation">항공서비스과</option>
                    <option value="16" id="japan">일본어과</option>
                    <option value="17" id="edu">유아교육과</option>
                    <option value="18" id="lit">문예창작과</option>
                    <option value="19" id="china">중국어비즈니스과</option>
                    <option value="20" id="id">산업디자인과</option>
                    <option value="21" id="comdes">커뮤니케이션디자인과</option>
                    <option value="22" id="fashion">패션리빙디자인과</option>
                    <option value="23" id="pe">사회체육과</option>
                    <option value="24" id="beauty">뷰티매니지먼트과</option>
                    <option value="25" id="health">보건의료정보과</option>
                    <option value="26" id="music">실용음악과</option>
                    <option value="27" id="theater">연극영상학과</option>
                </select>
                <div id="major-error" class="error-message"></div>
            </div>
            <div class="form-group flex">
                <label for="univ">학번</label>
                <div class="row">
                    <input type="text" class="input-field" id="stuNum" name="stuNum" placeholder="학번을 입력해 주세요." required>
                    <button type="button" class="duple-btn" onclick="$.checkStuNum();">중복체크</button>
                </div>
                <div id="stuNum-error" class="error-message"></div>
            </div>
            <div class="form-group">
                <button  type="submit" class="submit-btn" onclick="$.signup(event);" > 회원가입 완료</button>
            </div>
        </form>
        <div class="form-footer">
         <p>기존 회원이신가요? <a href="/login/login">로그인</a></p>
        </div>
    </div>
    </main>
</div>
</body>
<script>
    $(document).ready(function () {
        // 비밀번호 확인 입력 필드가 변경될 때마다 실행
        $("#passwordCheck").on("input", function () {
            const password = $("#password").val();
            const passwordCheck = $("#passwordCheck").val();

            if (password !== passwordCheck) {
                $("#passwordCheck-error").text("비밀번호가 일치하지 않습니다.");
                $("#passwordCheck").addClass("error-input");
            } else {
                $("#passwordCheck-error").text("");  // 메시지 지우기
                $("#passwordCheck").removeClass("error-input");
            }
        });
        // 모든 입력 필드에 대해 반복문을 돌면서 이벤트 리스너 추가
        $('input').not("#passwordCheck").on('input', function() {
            const errorMessageId = $(this).attr('id') + '-error';  // input 필드의 id를 가져와서 error 메시지 id 생성
            const errorMessage = $('#' + errorMessageId);

            if (errorMessage.length) {
                errorMessage.empty();  // 해당 input 필드와 관련된 오류 메시지 지우기
            }

        });

    });
    // 아이디 중복체크
    $.checkLoginId = function () {
        let loginId = $("#loginId").val();
        let loginInput =$("#loginId");

        if (loginId === "") {
            alert("아이디를 입력해주세요");
            return false;
        }
        if (loginId.length < 6 || loginId.length > 20) {
            alert("아이디는 6 ~ 20자 이내로 입력해주세요.");
            return false;
        }

        $.ajax({
            url: '/api/v1/user/checkId',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({loginId : loginId}),

            success: function (response) {
                // response(code, httpStatus, message, responseData)
                if (response.code === 200) {
                    if (response.responseData === true) {
                        alert("이미 사용중인 아이디입니다");
                        loginInput.css("border", "2px solid red");
                    }else {
                        alert("사용가능한 아이디입니다.");
                        // 중복체크 완료 시 테두리,배경색 변경 후 읽기전용으로 변경
                        loginInput.css("border", "2px solid green");
                        loginInput.css("background-color", "lightgrey");
                        loginInput.prop("readonly", true);
                    }

                }
            },
            error: function (xhr) {
                if (xhr.status === 400) {
                    alert("아이디 중복 체크에 실패했습니다: " + response.message);
                } else {
                    alert("예기치 못한 오류가 발생했습니다. 잠시 후 다시 시도해주세요.");
                }
            }
        });
    };



    // 닉네임 중복체크
    $.checkNickname = function () {
        let nickname = $("#nickname").val();
        let nicknameInput =$("#nickname");

        if (nickname === "") {
            alert("닉네임을 입력해주세요");
            return false;
        }
        if (nickname.length < 2 || nickname.length > 8) {
            alert("닉네임은 2 ~ 8자 이내로 입력해주세요.");
            return false;
        }

        $.ajax({
            url: '/api/v1/user/checkNickname',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({nickname : nickname}),

            success: function (response) {
                // response(code, httpStatus, message, responseData)

                if (response.code === 200) {
                    if (response.responseData === true) {
                        alert("이미 사용중인 닉네임입니다");
                        nicknameInput.css("border", "2px solid red");
                    }else {
                        alert("사용가능한 닉네임입니다.");
                        // 중복체크 완료 시 테두리,배경색 변경 후 읽기전용으로 변경
                        nicknameInput.css("border", "2px solid green");
                        nicknameInput.css("background-color", "lightgrey");
                        nicknameInput.prop("readonly", true);
                    }
                }
            },
            error: function (xhr) {
                if (xhr.status === 400) {
                    alert("닉네임 중복 체크에 실패했습니다: " + response.message);
                } else {
                    alert("예기치 못한 오류가 발생했습니다. 잠시 후 다시 시도해주세요.");
                }
            }
        });
    };
    $.checkEmail = function () {
        let email = $("#email").val();
        let emailInput =$("#email");

        if (email === "") {
            alert("이메일을 입력해주세요");
            return false;
        }

        $.ajax({
            url: '/api/v1/user/checkEmail',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({email : email}),

            success: function (response) {
                // response(code, httpStatus, message, responseData)

                if (response.code === 200) {
                    if (response.responseData === true) {
                        alert("이미 사용중인 이메일입니다");
                        emailInput.css("border", "2px solid red");
                    }else {
                        alert("사용가능한 이메일입니다.");
                        emailInput.css("border", "2px solid green");
                        emailInput.css("background-color", "lightgrey");
                        emailInput.prop("readonly", true);
                    }
                }
            },
            error: function (xhr) {
                if (xhr.status === 400) {
                    alert("이메일 중복 체크에 실패했습니다: " + response.message);
                } else {
                    alert("예기치 못한 오류가 발생했습니다. 잠시 후 다시 시도해주세요.");
                }
            }
        });
    };
    $.checkStuNum = function () {
        let stuNum = $("#stuNum").val();
        let stuNumInput =$("#stuNum");

        if (stuNum === "") {
            alert("학번을 입력해주세요");
            return false;
        }
        if (stuNum.length !== 10) {
            alert("학번은 10자여야 합니다.");
            return false;
        }

        $.ajax({
            url: '/api/v1/user/checkStuNum',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({stuNum : stuNum}),

            success: function (response) {
                // response(code, httpStatus, message, responseData)

                if (response.code === 200) {
                    if (response.responseData === true) {
                        alert("이미 사용중인 학번입니다");
                        stuNumInput.css("border", "2px solid red");
                    }else {
                        alert("사용가능한 학번입니다.");
                        stuNumInput.css("border", "2px solid green");
                        stuNumInput.css("background-color", "lightgrey");
                        stuNumInput.prop("readonly", true);
                    }
                }
            },
            error: function (xhr) {
                if (xhr.status === 400) {
                    alert("학번 중복 체크에 실패했습니다: " + response.message);
                } else {
                    alert("예기치 못한 오류가 발생했습니다. 잠시 후 다시 시도해주세요.");
                }
            }
        });
    };


    // 회원 가입
    $.signup = function () {

        event.preventDefault();  //폼 기본 제출 동작을 막음( submit 방지 )

        const formData = {
            loginId: $("#loginId").val(),
            password: $("#password").val(),
            passwordCheck: $("#passwordCheck").val(),
            name: $("#name").val(),
            nickname: $("#nickname").val(),
            phone: $("#phone").val(),
            email: $("#email").val(),
            univ: $("#univ").val(),
            majorId: $("#majorId").val(),
            stuNum: $("#stuNum").val()
        };

        // 기존 오류 메시지 초기화
        $(".error-message").text("");
        $("input").removeClass("error-input");

        $.ajax({
            url: '/api/v1/user/signup', // 회원가입 컨트롤러 엔드포인트
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),  // js객체를 json형식으로 변환

            success: function (response) {
                // response(code, httpStatus, message, responseData)
                if (response.code === 200) {
                    alert("회원가입이 완료되었습니다.");
                    window.location.href = '/login/login'; // 성공 시 로그인 화면으로 이동
                } else {
                    alert("회원가입 중 오류가 발생했습니다: " + response.message);
                }
            },
            error: function (xhr) {
                if (xhr.status === 400) {
                    const response = JSON.parse(xhr.responseText);
                    const errorMessages = response.responseData;
                    // 오류 메시지를 각 필드에 맞게 표시
                    if (Array.isArray(errorMessages)) {
                        errorMessages.forEach(error => {
                            const [field, message] = error.split(": ");
                            const errorField = field.replace(/'/g, ""); // 필드 이름에서 작은따옴표 제거

                            // 해당 필드에만 오류 스타일 적용
                            $(`#${errorField}`).addClass("error-input");
                            $(`#${errorField}-error`).text(message); // 필드 아래에 오류 메시지 표시
                        });
                    } else {

                        Object.entries(errorMessages).forEach(([field, message]) => {
                            const errorField = field.replace(/'/g, ""); // 필드 이름에서 작은따옴표 제거

                            // 해당 필드에만 오류 스타일 적용
                            $(`#${errorField}`).addClass("error-input");
                            $(`#${errorField}-error`).text(message); // 필드 아래에 오류 메시지 표시
                        });
                    }
                } else {
                    alert("예기치 못한 오류가 발생했습니다. 잠시 후 다시 시도해주세요.");
                }
            }
        });
    };

</script>
</html>
