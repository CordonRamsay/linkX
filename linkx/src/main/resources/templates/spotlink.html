<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ìŠ¤íŒŸë§í¬</title>
  <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=j5sii37kyv&submodules=geocoder"></script>
  <script language="JavaScript" src="/js/jquery-3.7.1.min.js"></script>
  <link rel="stylesheet" href="/spotlink/spotlink.css">
</head>
<body>
<div id="sidebar">
  <a class="logoBtn" href="/"><img class="logo" src="/img/linkxLogo.png"></a>
  <div id="filter-bar">
    <button class="filter-button" data-category="all">ì „ì²´</button>
    <button class="filter-button" data-category="ìŒì‹">ìŒì‹ì </button>
    <button class="filter-button" data-category="ì¹´í˜">ì¹´í˜</button>
    <button class="filter-button" data-category="PCë°©">PCë°©</button>
    <button class="filter-button" data-category="ë¬¸êµ¬">ë¬¸êµ¬</button>
    <button class="filter-button" data-category="ì€í–‰">ì€í–‰</button>
  </div>
  <div id="spot-list"></div>
  <div id="pagination" style="margin-top: 20px; display: flex; justify-content: center; gap: 5px;"></div>
</div>
<div id="map-container">
  <div id="map"></div>
</div>
<script>
  $(document).ready(function () {
    const mjcLocation = new naver.maps.LatLng(37.5846502, 126.9254007);

    const mapOptions = {
      center: mjcLocation,
      zoom: 17
    };
    const map = new naver.maps.Map('map', mapOptions);

    const mjcMarker = new naver.maps.Marker({
      position: mjcLocation,
      map: map,
      icon: {
        content: [
          `<div style="display: flex; flex-direction: column; align-items: center; width: 40px; height: 40px;">`,
          ` <div style="display: flex; justify-content: center; align-items: center; width: 40px; height: 40px;">`,
          ` <img src="/img/mjcSymbol.png" style="width: 40px; background-color: white; height: 40px; border-radius: 50%; border-width: 1px;"/>`,
          ` </div>`,
          `</div>`
        ].join(''),
        size: new naver.maps.Size(40, 40),
        scaledSize: new naver.maps.Size(40, 40),
        origin: new naver.maps.Point(0, 0)
      },
      zIndex: 100
    });


    let currentCategory = 'all';
    let markers = []; // í˜„ì¬ ë§µì— í‘œì‹œëœ ëª¨ë“  ë§ˆì»¤ë¥¼ ì €ì¥í•˜ëŠ” ë°°ì—´
    const infoWindow = new naver.maps.InfoWindow();
    let currentInfoWindow = null;

    // ì´ˆê¸° í•„í„° ë²„íŠ¼ "ì „ì²´" í™œì„±í™”
    const allButton = document.querySelector('.filter-button[data-category="all"]');
    if (allButton) {
      allButton.classList.add("active");
    }

    naver.maps.Event.addListener(map, 'click', function () {
      if (currentInfoWindow) {
        currentInfoWindow.close();
        currentInfoWindow = null;
      }
    });

    // ìŠ¤íŒŸ ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
    function loadSpots() {
      $.ajax({
        url: '/spotlink/data/list',
        type: 'GET',
        dataType: 'json',
        success: function (spots) {
          displaySpots(spots);
        },
        error: function (xhr) {
          console.error('Error fetching spot list:', xhr.responseText);
        }
      });
    }

    // ìŠ¤íŒŸ ë°ì´í„°ë¥¼ í™”ë©´ì— í‘œì‹œ
    function displaySpots(spots) {
      const spotList = $('#spot-list');
      spotList.empty();

      // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
      markers.forEach(marker => marker.setMap(null));
      markers = []; // ë§ˆì»¤ ë°°ì—´ ì´ˆê¸°í™”

      spots
              .filter(spot => {
                if (currentCategory === 'all') {
                  return true; // "ì „ì²´" ì„ íƒ ì‹œ ëª¨ë“  ë°ì´í„° í‘œì‹œ
                }
                const categories = spot.category.split(',');
                return categories.some(category => category.trim().includes(currentCategory));
              })
              .forEach(function (spot) {
                const lat = parseFloat(spot.mapY) / 1e7;
                const lng = parseFloat(spot.mapX) / 1e7;
                const latLng = new naver.maps.LatLng(lat, lng);

                // ë§ˆì»¤ ìƒì„± ë° ë§µì— ì¶”ê°€
                const marker = new naver.maps.Marker({
                  position: latLng,
                  map: map,
                  title: spot.title
                });
                markers.push(marker);

                // HTML íƒœê·¸ ì œê±°
                const plainTitle = spot.title.replace(/<[^>]*>/g, ''); // HTML íƒœê·¸ ì œê±°
                const encodedTitle = encodeURIComponent(plainTitle);

                // Spot ì•„ì´í…œ ìƒì„±
                const spotItem = $(`
        <div class="spot-item" data-spot-id="${spot.id}">
          <div class="spot-thumbnail">
            <img src="/img/default.png" alt="" class="thumbnail-image"> <!-- ê¸°ë³¸ ì´ë¯¸ì§€ -->
          </div>
          <div class="spot-info">
            <strong>${spot.title}</strong>
            <p class="road-address">
              <span class="icon">ğŸ“</span> ${spot.roadAddr}
            </p>
            <p>â­ ë³„ì  <b>${spot.avgRating.toFixed(1)}</b> ë¦¬ë·° <b>${spot.reviewCount}</b></p>
          </div>
        </div>
      `);

                const reviewContainer = $('<div class="review-container"></div>');
                const reviewFormButton = $('<button class="review-form-button">ë¦¬ë·° ì‘ì„±</button>');
                const reviewList = $('<div class="review-list"></div>');

                // ë¦¬ë·° ì‘ì„± ë²„íŠ¼ ì´ë²¤íŠ¸
                reviewFormButton.on('click', function (event) {
                  event.stopPropagation();
                  openReviewModal(spot.id, spot.title);
                });

                reviewContainer.append(reviewFormButton);
                reviewContainer.append(reviewList);

                // ë¦¬ìŠ¤íŠ¸ í´ë¦­ ì´ë²¤íŠ¸
                spotItem.on('click', function () {
                  map.setCenter(latLng);
                  const avgRating = spot.avgRating !== undefined && spot.avgRating !== null ? spot.avgRating.toFixed(1) : 'N/A';
                  const reviewCount = spot.reviewCount || 0;

                  const contentString = `
          <div style="padding:5px; font-size:14px;">
            <strong>${spot.title}</strong>
            <p>â­ <b>${avgRating}</b></p>
            <p>ğŸ’¬ <b>${reviewCount}</b></p>
          </div>
        `;
                  infoWindow.setContent(contentString);
                  infoWindow.open(map, marker);

                  if (reviewContainer.is(':visible')) {
                    reviewContainer.hide();
                    reviewList.empty();
                  } else {
                    reviewContainer.show();
                    loadReviews(spot.id, reviewList);
                  }
                });

                // AJAX ìš”ì²­ìœ¼ë¡œ ì´ë¯¸ì§€ URL ê°€ì ¸ì˜¤ê¸°
                $.ajax({
                  url: `/spotlink/data/image?title=${encodedTitle}`, // ì •ì œëœ title ì‚¬ìš©
                  type: 'GET',
                  success: function (imageUrl) {
                    // ì„±ê³µì ìœ¼ë¡œ ì´ë¯¸ì§€ ë°˜í™˜ ì‹œ ì—…ë°ì´íŠ¸
                    if (imageUrl) {
                      spotItem.find('.thumbnail-image').attr('src', imageUrl);
                    }
                  },
                  error: function () {
                    console.error(`ì´ë¯¸ì§€ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${plainTitle}`);
                  }
                });

                // Spot ì•„ì´í…œ ì¶”ê°€
                spotList.append(spotItem).append(reviewContainer);

                // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸
                naver.maps.Event.addListener(marker, 'click', function () {
                  const avgRating = spot.avgRating !== undefined && spot.avgRating !== null ? spot.avgRating.toFixed(1) : 'N/A';
                  const reviewCount = spot.reviewCount || 0;

                  const contentString = `
          <div style="padding:5px; font-size:14px;">
            <strong>${spot.title}</strong>
            <p>â­ <b>${avgRating}</b></p>
            <p>ğŸ’¬ <b>${reviewCount}</b></p>
          </div>
        `;
                  if (currentInfoWindow && currentInfoWindow.getContent() === contentString && currentInfoWindow.getMap()) {
                    currentInfoWindow.close();
                    currentInfoWindow = null;
                    return;
                  }

                  // ë‹¤ë¥¸ ë§ˆì»¤ë¥¼ í´ë¦­í–ˆê±°ë‚˜ InfoWindowê°€ ë‹«íŒ ê²½ìš° ìƒˆë¡œ ì—´ê¸°
                  if (currentInfoWindow) {
                    currentInfoWindow.close();
                  }

                  infoWindow.setContent(contentString);
                  infoWindow.open(map, marker);
                  currentInfoWindow = infoWindow;
                });
              });
    }





    // í•„í„° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    $('#filter-bar').on('click', '.filter-button', function () {
      $('.filter-button').removeClass('active');
      $(this).addClass('active');
      currentCategory = $(this).data('category');
      infoWindow.close();
      loadSpots();
    });
    // ì´ˆê¸° ë¡œë“œ
    loadSpots();
  });

  // ë¦¬ë·° ë¡œë“œ í•¨ìˆ˜
  function loadReviews(spotId, reviewList) {
    $.ajax({
      url: `/spotlink/data/reviews/${spotId}`,
      type: 'GET',
      dataType: 'json',
      success: function (reviews) {
        reviewList.empty();

        if (!reviews.length) {
          reviewList.append('<p>ë“±ë¡ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>');
          return;
        }

        reviews.forEach((review) => {
          const reviewItem = $(`
            <div class="review-item">
              <div>
                <h4>${review.reviewTitle}</h4>
                <p>${review.reviewContent}</p>
                <p>ì‘ì„±ì: ${review.userNickName}</p>
                <p>ë³„ì : ${'â­'.repeat(review.reviewStar)}</p>
                <p>ì‘ì„±ì¼: ${new Date(review.reviewDate).toLocaleDateString()}</p>
              </div>
              ${
                  review.canDelete
                          ? `<button class="delete-button" data-review-id="${review.id}">ì‚­ì œ</button>`
                          : ''
          }
            </div>
          `);
          // ë¦¬ë·° ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸
          reviewItem.find('.delete-button').on('click', function () {
            const reviewId = $(this).data('review-id');
            if (confirm('ë¦¬ë·°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
              deleteReview(reviewId, reviewItem);
            }
          });
          reviewList.append(reviewItem);
        });
      },
      error: function (xhr) {
        console.error('Error fetching reviews:', xhr.responseText);
      }
    });
  }

  // ë¦¬ë·° ì‚­ì œ í•¨ìˆ˜
  function deleteReview(reviewId, reviewItem) {
    const spotId = reviewItem.closest('.review-container').prev('.spot-item').data('spotId'); // ì—°ê²°ëœ spotId ê°€ì ¸ì˜¤ê¸°

    $.ajax({
      url: `/spotlink/data/reviews/${reviewId}`,
      type: 'DELETE',
      success: function () {
        alert('ë¦¬ë·°ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        reviewItem.remove(); // ì‚­ì œëœ ë¦¬ë·° DOMì—ì„œ ì œê±°

        // ë¦¬ë·° ì‚­ì œ í›„ ì¥ì†Œ ì •ë³´ ì—…ë°ì´íŠ¸
        const reviewList = $(`.spot-item[data-spot-id="${spotId}"]`).next('.review-container').find('.review-list');
        updateSpotInfo(spotId, reviewList);
      },
      error: function (xhr) {
        console.error('ë¦¬ë·° ì‚­ì œ ì¤‘ ì˜¤ë¥˜:', xhr.responseText);
        alert('ë¦¬ë·° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    });
  }


  // ë¦¬ë·° ì‘ì„± ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜
  function openReviewModal(spotId, spotTitle) {
    const modal = $('#review-modal');
    modal.css('display', 'flex').data('spotId', spotId); // display: flexë¡œ ê°•ì œ ì„¤ì •
    $('#spot-name').text(spotTitle.replace(/<[^>]*>?/g, '')); // HTML íƒœê·¸ ì œê±°
  }

  function closeReviewModal() {
    $('#review-modal').hide(); // display: noneìœ¼ë¡œ ìˆ¨ê¹€
  }

  function submitReview() {
    const modal = $('#review-modal');
    const spotId = modal.data('spotId');
    const reviewTitle = $('#review-title').val().trim();
    const reviewContent = $('#review-content').val().trim();
    const reviewStar = parseInt($('#review-star').val(), 10);

    if (!reviewTitle || !reviewContent || isNaN(reviewStar)) {
      alert('ëª¨ë“  í•„ë“œë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”.');
      return;
    }

    const reviewData = { spotId, reviewTitle, reviewContent, reviewStar };

    $.ajax({
      url: '/spotlink/data/reviews',
      type: 'POST',
      contentType: 'application/json',
      data: JSON.stringify(reviewData),
      success: function (newReview) {
        alert('ë¦¬ë·° ì‘ì„± ì™„ë£Œ!');
        closeReviewModal();

        const reviewList = $(`.spot-item[data-spot-id="${spotId}"]`).next().find('.review-list');
        loadReviews(spotId, reviewList);
        updateSpotInfo(spotId);
      },
      error: function (xhr) {
        console.error('Error adding review:', xhr.responseText);
        alert('ë¦¬ë·° ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    });
  }
  function updateSpotInfo(spotId) {
    $.ajax({
      url: `/spotlink/data/spot/${spotId}`, // íŠ¹ì • ì¥ì†Œì˜ ë³„ì ê³¼ ë¦¬ë·° ê°œìˆ˜ë¥¼ ë°˜í™˜í•˜ëŠ” API
      type: 'GET',
      success: function (spot) {
        const spotItem = $(`.spot-item[data-spot-id="${spotId}"]`);
        const avgRating = spot.avgRating !== undefined && spot.avgRating !== null ? spot.avgRating.toFixed(1) : 'N/A';
        const reviewCount = spot.reviewCount || 0;

        // ì¥ì†Œ ì •ë³´ ê°±ì‹ 
        spotItem.find('p:last').html(`â­ ë³„ì  <b>${avgRating}</b> ë¦¬ë·° <b>${reviewCount}</b>`);
      },
      error: function (xhr) {
        console.error('ì¥ì†Œ ì •ë³´ ê°±ì‹  ì¤‘ ì˜¤ë¥˜:', xhr.responseText);
      }
    });
  }
</script>
<div id="review-modal" class="modal">
  <div class="modal-content">
    <button class="modal-close" onclick="closeReviewModal()">Ã—</button>
    <h2>ë¦¬ë·° ì‘ì„±: <span id="spot-name"></span></h2>
    <div>
      <label for="review-title">ì œëª©</label>
      <input type="text" id="review-title" placeholder="ë¦¬ë·° ì œëª©" style="width: 100%; margin-bottom: 10px;">
    </div>
    <div>
      <label for="review-content">ë‚´ìš©</label>
      <textarea id="review-content" rows="3" placeholder="ë¦¬ë·° ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" style="width: 100%; margin-bottom: 10px;"></textarea>
    </div>
    <div>
      <label for="review-star">ë³„ì </label>
      <select id="review-star" style="width: 100%; margin-bottom: 10px;">
        <option value="5">â­â­â­â­â­</option>
        <option value="4">â­â­â­â­</option>
        <option value="3">â­â­â­</option>
        <option value="2">â­â­</option>
        <option value="1">â­</option>
      </select>
    </div>
    <div class="button-group">
      <button onclick="closeReviewModal()">ì·¨ì†Œ</button>
      <button onclick="submitReview()">ì‘ì„±</button>
    </div>
  </div>
</div>
</body>
</html>
