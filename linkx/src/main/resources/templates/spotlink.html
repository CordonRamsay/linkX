<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>스팟링크</title>
  <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=j5sii37kyv&submodules=geocoder"></script>
  <script language="JavaScript" src="/js/jquery-3.7.1.min.js"></script>
  <style>
    body {
      display: flex;
      margin: 0;
      padding: 0;
      font-family: 'Arial', sans-serif;
    }

    #sidebar {
      width: 30%;
      max-width: 400px;
      background: #ffffff;
      border-right: 1px solid #ddd;
      padding: 20px;
      overflow-y: auto;
      height: 100vh;
      box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
    }

    .logoBtn {
      display: block; /* 인라인 요소에서 블록 요소로 변경 */
      margin-bottom: 20px; /* 로고와 아래 요소 간의 여백 */
    }

    #filter-bar {
      display: flex; /* 버튼을 가로로 나열 */
      justify-content: space-between; /* 버튼 간 동일한 간격 */
      gap: 10px; /* 버튼 간 간격 */
      margin-bottom: 20px;
    }

    .filter-button {
      flex: 1; /* 버튼이 동일한 크기로 확장 */
      max-width: 150px; /* 버튼의 최대 너비 제한 */
      height: 30px; /* 버튼 높이 고정 */
      border: 1px solid #ddd;
      background: #fff;
      border-radius: 25px; /* 버튼을 둥글게 처리 */
      cursor: pointer;
      font-size: 12px;
      color: #333;
      text-align: center; /* 텍스트를 가로 중앙 정렬 */
      transition: background-color 0.3s, color 0.3s;
      box-sizing: border-box;
    }

    .filter-button.active {
      font-weight: bold;
      background: #FFFFFF;
      color: #000000;
      border-width: 2px;
      border-color: #F76394;
      box-sizing: border-box;
    }

    #spot-list {
      margin: 0;
      padding: 0;
    }

    .spot-item {
      border: 1px solid #ddd;
      margin-bottom: 15px;
      padding: 15px;
      cursor: pointer;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .spot-item:hover {
      background: #f9f9f9;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .spot-item strong {
      font-size: 16px;
      color: #333;
    }

    .spot-item p {
      margin: 5px 0;
      font-size: 14px;
      color: #666;
    }

    #map-container {
      flex: 1;
      height: 100vh;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    .review-item {
      border: 1px solid #ddd;
      padding: 10px;
      margin: 10px 0;
      position: relative;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .review-item h4 {
      font-size: 14px;
      margin-bottom: 5px;
      color: #333;
    }

    .review-item p {
      font-size: 13px;
      margin: 3px 0;
      color: #555;
    }

    .review-container {
      margin-top: 10px;
      padding: 15px;
      border-top: 1px solid #ddd;
      background-color: #f9f9f9;
      border-radius: 8px;
      display: none;
    }
    .review-form-button {
      display: block;
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: none;
      background-color: #007bff;
      color: white;
      font-weight: bold;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .review-form-button:hover {
      background-color: #0056b3;
    }

    .delete-button {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background-color: #e74c3c;
      color: white;
      border: none;
      cursor: pointer;
      padding: 5px 10px;
      font-size: 12px;
      border-radius: 5px;
      transition: background-color 0.3s;
    }

    .delete-button:hover {
      background-color: #c0392b;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      justify-content: center; /* 가로 중앙 정렬 */
      align-items: center; /* 세로 중앙 정렬 */
    }

    .modal-content {
      background-color: #fff;
      padding: 20px;
      border-radius: 10px;
      width: 400px;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
      position: relative;
    }

    .modal-content h2 {
      margin-top: 0;
      font-size: 18px;
      color: #333;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 20px;
      position: absolute;
      top: 10px;
      right: 10px;
      cursor: pointer;
    }
    .pagination-btn {
      padding: 5px 10px;
      border: 1px solid #ddd;
      background-color: #fff;
      cursor: pointer;
      border-radius: 5px;
      margin: 0 5px;
      transition: background-color 0.3s;
    }

    .pagination-btn.active {
      background-color: #007BFF;
      color: #fff;
      border-color: #007BFF;
    }

    .pagination-btn:disabled {
      background-color: #f9f9f9;
      color: #ccc;
      cursor: not-allowed;
    }

    .pagination-btn:hover:not(:disabled) {
      background-color: #f0f0f0;
    }
  </style>
</head>
<body>
<div id="sidebar">
  <a class="logoBtn" href="/"><img class="logo" src="/img/linkxLogo.png"></a>
  <div id="filter-bar">
    <button class="filter-button" data-category="all">전체</button>
    <button class="filter-button" data-category="음식">음식점</button>
    <button class="filter-button" data-category="카페">카페</button>
    <button class="filter-button" data-category="PC방">PC방</button>
    <button class="filter-button" data-category="문구">문구</button>
    <button class="filter-button" data-category="은행">은행</button>
  </div>
  <div id="spot-list"></div>
  <div id="pagination" style="margin-top: 20px; display: flex; justify-content: center; gap: 5px;"></div>
</div>
<div id="map-container">
  <div id="map"></div>
</div>
<script>
  $(document).ready(function () {
    const mjcLocation = new naver.maps.LatLng(37.5846502, 126.9254007);

    const mapOptions = {
      center: mjcLocation,
      zoom: 17
    };
    const map = new naver.maps.Map('map', mapOptions);

    const mjcMarker = new naver.maps.Marker({
      position: mjcLocation,
      map: map,
      icon: {
        content: [
          `<div style="display: flex; flex-direction: column; align-items: center; width: 40px; height: 40px;">`,
          ` <div style="display: flex; justify-content: center; align-items: center; width: 40px; height: 40px;">`,
          ` <img src="/img/mjcSymbol.png" style="width: 40px; background-color: white; height: 40px; border-radius: 50%; border-width: 1px;"/>`,
          ` </div>`,
          `</div>`
        ].join(''),
        size: new naver.maps.Size(40, 40),
        scaledSize: new naver.maps.Size(40, 40),
        origin: new naver.maps.Point(0, 0)
      },
      zIndex: 100
    });


    let currentCategory = 'all';
    let markers = []; // 현재 맵에 표시된 모든 마커를 저장하는 배열
    const infoWindow = new naver.maps.InfoWindow();

    // 초기 필터 버튼 "전체" 활성화
    const allButton = document.querySelector('.filter-button[data-category="all"]');
    if (allButton) {
      allButton.classList.add("active");
    }

    // 스팟 데이터 로드 함수
    function loadSpots() {
      $.ajax({
        url: '/spotlink/data/list',
        type: 'GET',
        dataType: 'json',
        success: function (spots) {
          displaySpots(spots);
        },
        error: function (xhr) {
          console.error('Error fetching spot list:', xhr.responseText);
        }
      });
    }

    // 스팟 데이터를 화면에 표시
    function displaySpots(spots) {
      const spotList = $('#spot-list');
      spotList.empty();

      // 기존 마커 제거
      markers.forEach(marker => marker.setMap(null));
      markers = []; // 마커 배열 초기화


      spots
              .filter(spot => {
                if (currentCategory === 'all') {
                  return true; // "전체" 선택 시 모든 데이터 표시
                }
                // 쉼표로 구분된 카테고리를 배열로 분리 후 필터링
                const categories = spot.category.split(',');
                return categories.some(category => category.trim().includes(currentCategory));
              })
              .forEach(function (spot) {
                const lat = parseFloat(spot.mapY) / 1e7;
                const lng = parseFloat(spot.mapX) / 1e7;
                const latLng = new naver.maps.LatLng(lat, lng);

                // 마커 생성 및 맵에 추가
                const marker = new naver.maps.Marker({
                  position: latLng,
                  map: map,
                  title: spot.title
                });
                markers.push(marker);

                naver.maps.Event.addListener(marker, 'click', function () {
                  const avgRating = spot.avgRating !== undefined && spot.avgRating !== null ? spot.avgRating.toFixed(1) : 'N/A';
                  const reviewCount = spot.reviewCount || 0;

                  // infoWindow에 표시할 HTML 내용
                  const contentString = `
    <div style="padding:5px; font-size:14px;">
      <strong>${spot.title}</strong>
      <p>⭐ <b>${avgRating}</b></p>
      <p>💬 <b>${reviewCount}</b></p>
    </div>
  `;
                  // infoWindow에 내용 설정 및 열기
                  infoWindow.setContent(contentString);
                  infoWindow.open(map, marker);
                });


                // 리스트 항목 생성
                const spotItem = $(`
            <div class="spot-item" data-spot-id="${spot.id}">
              <div>
                <strong>${spot.title}</strong>
                <p>${spot.addr}</p>
                <p>${spot.roadAddr}</p>
                <p>⭐별점 <b>${spot.avgRating.toFixed(1)}</b> 리뷰 <b>${spot.reviewCount}</b></p>
              </div>
            </div>
          `);

                const reviewContainer = $('<div class="review-container"></div>');
                const reviewFormButton = $('<button class="review-form-button">리뷰 작성</button>');
                const reviewList = $('<div class="review-list"></div>');

                // 리뷰 작성 버튼 이벤트
                reviewFormButton.on('click', function (event) {
                  event.stopPropagation();
                  openReviewModal(spot.id, spot.title);
                });

                reviewContainer.append(reviewFormButton);
                reviewContainer.append(reviewList);

                // 리스트 클릭 이벤트
                spotItem.on('click', function () {
                  map.setCenter(latLng);
                  const avgRating = spot.avgRating !== undefined && spot.avgRating !== null ? spot.avgRating.toFixed(1) : 'N/A';
                  const reviewCount = spot.reviewCount || 0;

                  // infoWindow에 표시할 HTML 내용
                  const contentString = `
    <div style="padding:5px; font-size:14px;">
      <strong>${spot.title}</strong>
      <p>⭐ <b>${avgRating}</b></p>
      <p>💬 <b>${reviewCount}</b></p>
    </div>
  `;

                  // infoWindow에 내용 설정 및 열기
                  infoWindow.setContent(contentString);
                  infoWindow.open(map, marker);

                  if (reviewContainer.is(':visible')) {
                    reviewContainer.hide();
                    reviewList.empty();
                  } else {
                    reviewContainer.show();
                    loadReviews(spot.id, reviewList);
                  }
                });

                spotList.append(spotItem).append(reviewContainer);
              });
    }

    // 필터 버튼 클릭 이벤트
    $('#filter-bar').on('click', '.filter-button', function () {
      $('.filter-button').removeClass('active');
      $(this).addClass('active');
      currentCategory = $(this).data('category');
      infoWindow.close();
      loadSpots();
    });
    // 초기 로드
    loadSpots();
  });

  // 리뷰 로드 함수
  function loadReviews(spotId, reviewList) {
    $.ajax({
      url: `/spotlink/data/reviews/${spotId}`,
      type: 'GET',
      dataType: 'json',
      success: function (reviews) {
        reviewList.empty();

        if (!reviews.length) {
          reviewList.append('<p>등록된 리뷰가 없습니다.</p>');
          return;
        }

        reviews.forEach((review) => {
          const reviewItem = $(`
            <div class="review-item">
              <div>
                <h4>${review.reviewTitle}</h4>
                <p>${review.reviewContent}</p>
                <p>작성자: ${review.userNickName}</p>
                <p>별점: ${'⭐'.repeat(review.reviewStar)}</p>
                <p>작성일: ${new Date(review.reviewDate).toLocaleDateString()}</p>
              </div>
              ${
                  review.canDelete
                          ? `<button class="delete-button" data-review-id="${review.id}">삭제</button>`
                          : ''
          }
            </div>
          `);
          // 리뷰 삭제 버튼 이벤트
          reviewItem.find('.delete-button').on('click', function () {
            const reviewId = $(this).data('review-id');
            if (confirm('리뷰를 삭제하시겠습니까?')) {
              deleteReview(reviewId, reviewItem);
            }
          });
          reviewList.append(reviewItem);
        });
      },
      error: function (xhr) {
        console.error('Error fetching reviews:', xhr.responseText);
      }
    });
  }

  // 리뷰 삭제 함수
  function deleteReview(reviewId, reviewItem) {
    const spotId = reviewItem.closest('.review-container').prev('.spot-item').data('spotId'); // 연결된 spotId 가져오기

    $.ajax({
      url: `/spotlink/data/reviews/${reviewId}`,
      type: 'DELETE',
      success: function () {
        alert('리뷰가 성공적으로 삭제되었습니다.');
        reviewItem.remove(); // 삭제된 리뷰 DOM에서 제거

        // 리뷰 삭제 후 장소 정보 업데이트
        const reviewList = $(`.spot-item[data-spot-id="${spotId}"]`).next('.review-container').find('.review-list');
        updateSpotInfo(spotId, reviewList);
      },
      error: function (xhr) {
        console.error('리뷰 삭제 중 오류:', xhr.responseText);
        alert('리뷰 삭제 중 오류가 발생했습니다.');
      }
    });
  }


  // 리뷰 작성 모달 관련 함수
  function openReviewModal(spotId, spotTitle) {
    const modal = $('#review-modal');
    modal.css('display', 'flex').data('spotId', spotId); // display: flex로 강제 설정
    $('#spot-name').text(spotTitle.replace(/<[^>]*>?/g, '')); // HTML 태그 제거
  }

  function closeReviewModal() {
    $('#review-modal').hide(); // display: none으로 숨김
  }

  function submitReview() {
    const modal = $('#review-modal');
    const spotId = modal.data('spotId');
    const reviewTitle = $('#review-title').val().trim();
    const reviewContent = $('#review-content').val().trim();
    const reviewStar = parseInt($('#review-star').val(), 10);

    if (!reviewTitle || !reviewContent || isNaN(reviewStar)) {
      alert('모든 필드를 올바르게 입력하세요.');
      return;
    }

    const reviewData = { spotId, reviewTitle, reviewContent, reviewStar };

    $.ajax({
      url: '/spotlink/data/reviews',
      type: 'POST',
      contentType: 'application/json',
      data: JSON.stringify(reviewData),
      success: function (newReview) {
        alert('리뷰 작성 완료!');
        closeReviewModal();

        const reviewList = $(`.spot-item[data-spot-id="${spotId}"]`).next().find('.review-list');
        loadReviews(spotId, reviewList);
        updateSpotInfo(spotId);
      },
      error: function (xhr) {
        console.error('Error adding review:', xhr.responseText);
        alert('리뷰 작성 중 오류가 발생했습니다.');
      }
    });
  }
  function updateSpotInfo(spotId) {
    $.ajax({
      url: `/spotlink/data/spot/${spotId}`, // 특정 장소의 별점과 리뷰 개수를 반환하는 API
      type: 'GET',
      success: function (spot) {
        const spotItem = $(`.spot-item[data-spot-id="${spotId}"]`);
        const avgRating = spot.avgRating !== undefined && spot.avgRating !== null ? spot.avgRating.toFixed(1) : 'N/A';
        const reviewCount = spot.reviewCount || 0;

        // 장소 정보 갱신
        spotItem.find('p:last').html(`⭐ 별점 <b>${avgRating}</b> 리뷰 <b>${reviewCount}</b>`);
      },
      error: function (xhr) {
        console.error('장소 정보 갱신 중 오류:', xhr.responseText);
      }
    });
  }
</script>
<div id="review-modal" class="modal">
  <div class="modal-content">
    <button class="modal-close" onclick="closeReviewModal()">×</button>
    <h2>리뷰 작성: <span id="spot-name"></span></h2>
    <div>
      <label for="review-title">제목</label>
      <input type="text" id="review-title" placeholder="리뷰 제목" style="width: 100%; margin-bottom: 10px;">
    </div>
    <div>
      <label for="review-content">내용</label>
      <textarea id="review-content" rows="3" placeholder="리뷰 내용을 입력하세요" style="width: 100%; margin-bottom: 10px;"></textarea>
    </div>
    <div>
      <label for="review-star">별점</label>
      <select id="review-star" style="width: 100%; margin-bottom: 10px;">
        <option value="5">⭐⭐⭐⭐⭐</option>
        <option value="4">⭐⭐⭐⭐</option>
        <option value="3">⭐⭐⭐</option>
        <option value="2">⭐⭐</option>
        <option value="1">⭐</option>
      </select>
    </div>
    <div class="button-group">
      <button onclick="closeReviewModal()">취소</button>
      <button onclick="submitReview()">작성</button>
    </div>
  </div>
</div>
</body>
</html>
