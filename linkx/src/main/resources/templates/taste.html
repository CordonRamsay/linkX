<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>맛집 지도</title>
  <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=j5sii37kyv&submodules=geocoder"></script>
  <script language="JavaScript" src="/js/jquery-3.7.1.min.js"></script>
  <style>
    body {
      display: flex;
      margin: 0;
      padding: 0;
      font-family: 'Arial', sans-serif;
    }

    #sidebar {
      width: 30%;
      max-width: 400px;
      background: #ffffff;
      border-right: 1px solid #ddd;
      padding: 20px;
      overflow-y: auto;
      height: 100vh;
      box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
    }

    .logoBtn {
      display: block; /* 인라인 요소에서 블록 요소로 변경 */
      margin-bottom: 20px; /* 로고와 아래 요소 간의 여백 */
    }

    #filter-bar {
      display: flex; /* 버튼을 가로로 나열 */
      justify-content: space-between; /* 버튼 간 동일한 간격 */
      gap: 10px; /* 버튼 간 간격 */
      margin-bottom: 20px;
    }

    .filter-button {
      flex: 1; /* 버튼이 동일한 크기로 확장 */
      max-width: 150px; /* 버튼의 최대 너비 제한 */
      height: 30px; /* 버튼 높이 고정 */
      border: 1px solid #ddd;
      background: #fff;
      border-radius: 25px; /* 버튼을 둥글게 처리 */
      cursor: pointer;
      font-size: 12px;
      color: #333;
      text-align: center; /* 텍스트를 가로 중앙 정렬 */
      transition: background-color 0.3s, color 0.3s;
      box-sizing: border-box;
    }

    .filter-button.active {
      font-weight: bold;
      background: #FFFFFF;
      color: #000000;
      border-width: 2px;
      border-color: #F76394;
      box-sizing: border-box;
    }

    #restaurant-list {
      margin: 0;
      padding: 0;
    }

    .restaurant-item {
      border: 1px solid #ddd;
      margin-bottom: 15px;
      padding: 15px;
      cursor: pointer;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .restaurant-item:hover {
      background: #f9f9f9;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .restaurant-item strong {
      font-size: 16px;
      color: #333;
    }

    .restaurant-item p {
      margin: 5px 0;
      font-size: 14px;
      color: #666;
    }

    #map-container {
      flex: 1;
      height: 100vh;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    .review-item {
      border: 1px solid #ddd;
      padding: 10px;
      margin: 10px 0;
      position: relative;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .review-item h4 {
      font-size: 14px;
      margin-bottom: 5px;
      color: #333;
    }

    .review-item p {
      font-size: 13px;
      margin: 3px 0;
      color: #555;
    }

    .delete-button {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: #e74c3c;
      color: white;
      border: none;
      cursor: pointer;
      padding: 5px 10px;
      font-size: 12px;
      border-radius: 5px;
      transition: background-color 0.3s;
    }

    .delete-button:hover {
      background-color: #c0392b;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: #fff;
      padding: 20px;
      border-radius: 10px;
      width: 400px;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
      position: relative;
    }

    .modal-content h2 {
      margin-top: 0;
      font-size: 18px;
      color: #333;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 20px;
      position: absolute;
      top: 10px;
      right: 10px;
      cursor: pointer;
    }
    .pagination-btn {
      padding: 5px 10px;
      border: 1px solid #ddd;
      background-color: #fff;
      cursor: pointer;
      border-radius: 5px;
      margin: 0 5px;
      transition: background-color 0.3s;
    }

    .pagination-btn.active {
      background-color: #007BFF;
      color: #fff;
      border-color: #007BFF;
    }

    .pagination-btn:disabled {
      background-color: #f9f9f9;
      color: #ccc;
      cursor: not-allowed;
    }

    .pagination-btn:hover:not(:disabled) {
      background-color: #f0f0f0;
    }
  </style>
</head>
<body>
<div id="sidebar">
  <a class="logoBtn" href="/"><img class="logo" src="/img/linkxLogo.png"></a>
  <div id="filter-bar">
    <button class="filter-button" data-category="all">전체</button>
    <button class="filter-button" data-category="음식">음식점</button>
    <button class="filter-button" data-category="카페">카페</button>
    <button class="filter-button" data-category="PC방">PC방</button>
    <button class="filter-button" data-category="문구">문구</button>
    <button class="filter-button" data-category="은행">은행</button>
  </div>
  <div id="restaurant-list"></div>
  <div id="pagination" style="margin-top: 20px; display: flex; justify-content: center; gap: 5px;"></div>
</div>
<div id="map-container">
  <div id="map"></div>
</div>
<script>
  $(document).ready(function () {
    const mapOptions = {
      center: new naver.maps.LatLng(37.58469198890765, 126.92568962210997),
      zoom: 17
    };
    const map = new naver.maps.Map('map', mapOptions);
    let currentCategory = 'all';
    let markers = []; // 현재 맵에 표시된 모든 마커를 저장하는 배열
    const allButton = document.querySelector('.filter-button[data-category="all"]');
    if (allButton) {
      allButton.classList.add("active"); // 초기 active 클래스 추가
    }
    function loadRestaurants() {
      $.ajax({
        url: '/taste/data/list',
        type: 'GET',
        dataType: 'json',
        success: function (restaurants) {
          displayRestaurants(restaurants);
        },
        error: function (xhr) {
          console.error('Error fetching restaurant list:', xhr.responseText);
        }
      });
    }

    function displayRestaurants(restaurants) {
      const restaurantList = $('#restaurant-list');
      restaurantList.empty();

      // 기존 마커 제거
      markers.forEach(marker => marker.setMap(null));
      markers = []; // 마커 배열 초기화

      restaurants
              .filter(restaurant => {
                if (currentCategory === 'all') {
                  return true; // "전체"일 경우 모든 데이터 표시
                }
                // 쉼표로 구분된 카테고리를 배열로 분리 후, 현재 선택된 카테고리가 포함되었는지 확인
                const categories = restaurant.category.split(',');
                return categories.some(category => category.trim().includes(currentCategory));
              })
              .forEach(function (restaurant) {
                const lat = parseFloat(restaurant.mapY) / 1e7;
                const lng = parseFloat(restaurant.mapX) / 1e7;
                const latLng = new naver.maps.LatLng(lat, lng);

                // 마커 생성 및 맵에 추가
                const marker = new naver.maps.Marker({
                  position: latLng,
                  map: map,
                  title: restaurant.title
                });
                markers.push(marker); // 새로 생성된 마커를 배열에 추가

                const infoWindow = new naver.maps.InfoWindow({
                  content: `<div style="padding:5px;">${restaurant.title}</div>`
                });

                naver.maps.Event.addListener(marker, 'click', function () {
                  infoWindow.open(map, marker);
                });

                // 리스트 항목 생성
                const restaurantItem = $(`
                    <div class="restaurant-item" data-rest-id="${restaurant.id}">
                    <div>
                    <strong>${restaurant.title}</strong>
                    <p>${restaurant.addr}</p>
                    <p>${restaurant.roadAddr}</p>
                    </div>
                </div>
                `);
                const reviewContainer = $('<div style="margin-top: 10px; padding-left: 20px; display: none;"></div>');
                const reviewFormButton = $('<button style="margin-top: 10px;">리뷰 작성</button>');
                const reviewList = $('<div class="review-list" style="margin-top: 10px;"></div>');
                reviewFormButton.on('click', function (event) {
                  event.stopPropagation();
                  openReviewModal(restaurant.id, restaurant.title);
                });

                reviewContainer.append(reviewFormButton);
                reviewContainer.append(reviewList);

                restaurantItem.on('click', function () {
                  map.setCenter(latLng);
                  infoWindow.open(map, marker);

                  if (reviewContainer.is(':visible')) {
                    reviewContainer.hide();
                    reviewList.empty();
                  } else {
                    reviewContainer.show();
                    loadReviews(restaurant.id, reviewList);
                  }
                });

                restaurantList.append(restaurantItem).append(reviewContainer);
              });
    }

    $('#filter-bar').on('click', '.filter-button', function () {
      $('.filter-button').removeClass('active');
      $(this).addClass('active');
      currentCategory = $(this).data('category');
      loadRestaurants();
    });

    loadRestaurants();
  });
  function loadReviews(restId, reviewList, currentPage = 1) {
    const itemsPerPage = 4; // 한 페이지에 표시할 리뷰 수

    $.ajax({
      url: `/taste/data/reviews/${restId}`,
      type: 'GET',
      dataType: 'json',
      success: function (reviews) {
        reviewList.empty();

        if (!reviews.length) {
          reviewList.append('<p>등록된 리뷰가 없습니다.</p>');
          return;
        }

        // 페이징 처리
        const totalPages = Math.ceil(reviews.length / itemsPerPage);
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const paginatedReviews = reviews.slice(startIndex, endIndex);

        // 리뷰 표시
        paginatedReviews.forEach((review) => {
          const reviewItem = $(`
          <div class="review-item">
            <div>
              <h4>${review.reviewTitle}</h4>
              <p>${review.reviewContent}</p>
              <p>작성자: ${review.userNickName}</p>
              <p>별점: ${'⭐'.repeat(review.reviewStar)}</p>
              <p>작성일: ${new Date(review.reviewDate).toLocaleDateString()}</p>
            </div>
            ${
                  review.canDelete
                          ? `<button class="delete-button" data-review-id="${review.id}">삭제</button>`
                          : ''
          }
          </div>
        `);

          // 삭제 버튼 이벤트 연결
          reviewItem.find('.delete-button').on('click', function () {
            const reviewId = $(this).data('review-id');
            if (confirm('리뷰를 삭제하시겠습니까?')) {
              deleteReview(reviewId, reviewItem);
            }
          });

          reviewList.append(reviewItem);
        });

        // 페이징 UI 추가
        renderReviewPagination(restId, reviewList, currentPage, totalPages);
      },
      error: function (xhr) {
        console.error('Error fetching reviews:', xhr.responseText);
      }
    });
  }

  function renderReviewPagination(restId, reviewList, currentPage, totalPages) {
    const paginationContainer = $('<div class="pagination"></div>');
    reviewList.append(paginationContainer);

    if (totalPages <= 1) return; // 페이지가 1개 이하일 경우 페이징 표시 안 함

    // 이전 버튼
    const prevButton = $(`<button class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''}>이전</button>`);
    prevButton.on('click', function () {
      if (currentPage > 1) {
        loadReviews(restId, reviewList, currentPage - 1);
      }
    });
    paginationContainer.append(prevButton);

    // 페이지 번호 버튼
    for (let i = 1; i <= totalPages; i++) {
      const pageButton = $(`<button class="pagination-btn ${i === currentPage ? 'active' : ''}">${i}</button>`);
      pageButton.on('click', function () {
        loadReviews(restId, reviewList, i);
      });
      paginationContainer.append(pageButton);
    }

    // 다음 버튼
    const nextButton = $(`<button class="pagination-btn" ${currentPage === totalPages ? 'disabled' : ''}>다음</button>`);
    nextButton.on('click', function () {
      if (currentPage < totalPages) {
        loadReviews(restId, reviewList, currentPage + 1);
      }
    });
    paginationContainer.append(nextButton);
  }


  function deleteReview(reviewId, reviewItem) {
    $.ajax({
      url: `/taste/data/reviews/${reviewId}`,
      type: 'DELETE',
      success: function () {
        alert('리뷰가 성공적으로 삭제되었습니다.');
        reviewItem.remove();
      },
      error: function (xhr) {
        console.error('Error deleting review:', xhr.responseText);
        alert('리뷰 삭제 중 오류가 발생했습니다.');
      }
    });
  }
  function openReviewModal(restId, restaurantTitle) {
    const modal = $('#review-modal');
    modal.show().data('restId', restId);
    $('#restaurant-name').text(restaurantTitle.replace(/<[^>]*>?/g, ''));
  }

  function closeReviewModal() {
    $('#review-modal').hide();
  }

  function submitReview() {
    const modal = $('#review-modal');
    const restId = modal.data('restId');
    const reviewTitle = $('#review-title').val().trim();
    const reviewContent = $('#review-content').val().trim();
    const reviewStar = parseInt($('#review-star').val(), 10);

    if (!reviewTitle || !reviewContent || isNaN(reviewStar) || reviewStar < 1 || reviewStar > 5) {
      alert('모든 필드를 올바르게 입력하세요. 별점은 1~5 사이의 숫자여야 합니다.');
      return;
    }

    const reviewData = { restId, reviewTitle, reviewContent, reviewStar };

    $.ajax({
      url: '/taste/data/reviews',
      type: 'POST',
      contentType: 'application/json',
      data: JSON.stringify(reviewData),
      success: function (newReview) {
        alert('리뷰 작성 완료!');
        const reviewList = $(`.restaurant-item[data-rest-id="${restId}"]`).next().find('.review-list');

        // 최신 리뷰 데이터를 DB에서 다시 가져와 목록 갱신
        loadReviews(restId, reviewList);

        // 모달 닫기
        closeReviewModal();
      },
      error: function (xhr) {
        console.error('Error adding review:', xhr.responseText);
        alert('리뷰 작성 중 오류가 발생했습니다.');
      }
    });
  }
</script>
<div id="review-modal" class="modal">
  <div class="modal-content">
    <button class="modal-close" onclick="closeReviewModal()">×</button>
    <h2>리뷰 작성: <span id="restaurant-name"></span></h2>
    <div>
      <label for="review-title">제목</label>
      <input type="text" id="review-title" placeholder="리뷰 제목" style="width: 100%; margin-bottom: 10px;">
    </div>
    <div>
      <label for="review-content">내용</label>
      <textarea id="review-content" rows="3" placeholder="리뷰 내용을 입력하세요" style="width: 100%; margin-bottom: 10px;"></textarea>
    </div>
    <div>
      <label for="review-star">별점</label>
      <select id="review-star" style="width: 100%; margin-bottom: 10px;">
        <option value="1">⭐</option>
        <option value="2">⭐⭐</option>
        <option value="3">⭐⭐⭐</option>
        <option value="4">⭐⭐⭐⭐</option>
        <option value="5">⭐⭐⭐⭐⭐</option>
      </select>
    </div>
    <div class="button-group">
      <button onclick="closeReviewModal()">취소</button>
      <button onclick="submitReview()">작성</button>
    </div>
  </div>
</div>

</body>
</html>
